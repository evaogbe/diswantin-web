name: ğŸš€ Deploy

on:
  push:
    branches: [main]
  pull_request:

jobs:
  format:
    name: ğŸ¨ Format
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ github.head_ref }}
      - name: â” Set up Node.js
        uses: actions/setup-node@v4.2.0
        with:
          cache: npm
          node-version: 22
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      - name: ğŸ¨ Format
        run: npm run format
      - name: âœ”ï¸ Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5.1.0
        with:
          commit_message: ğŸ¨ Apply formatting changes
          branch: ${{ github.head_ref }}

  typecheck:
    name: Ê¦ Type check
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4.2.2
      - name: â” Set up Node.js
        uses: actions/setup-node@v4.2.0
        with:
          cache: npm
          node-version: 22
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      - name: ğŸ” Type check
        run: npm run typecheck

  lint:
    name: â¬£ Lint
    runs-on: ubuntu-latest
    needs: [format]
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4.2.2
      - name: â” Set up Node.js
        uses: actions/setup-node@v4.2.0
        with:
          cache: npm
          node-version: 22
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      - name: ğŸ·ï¸ Generate types
        run: npx react-router typegen
      - name: ğŸ”¬ Lint
        run: npm run lint

  spellcheck:
    name: âœï¸ Spell check
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4.2.2
      - name: âœï¸ Spell check
        uses: streetsidesoftware/cspell-action@v6.10.1

  unit-test:
    name: âš¡ Unit tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: password
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4.2.2
      - name: â” Set up Node.js
        uses: actions/setup-node@v4.2.0
        with:
          cache: npm
          node-version: 22
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      - name: ğŸ©¹ Patch package
        run: npx patch-package
      - name: ğŸ—ƒï¸ Setup test DB
        run: npm run test:setup
      - name: âš¡ Run unit tests
        run: npm run test:unit -- --run

  e2e-test:
    name: ğŸ­ End-to-end tests
    timeout-minutes: 60
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: password
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4.2.2
      - name: â” Set up Node.js
        uses: actions/setup-node@v4.2.0
        with:
          cache: npm
          node-version: 22
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      - name: ğŸ©¹ Patch package
        run: npx patch-package
      - name: ğŸ“¥ Install browsers
        run: npm run init:test
      - name: ğŸ—ƒï¸ Setup test DB
        run: npm run test:setup
      - name: ğŸ­ Run end-to-end tests
        run: npm run test:e2e
      - name: ğŸ“Š Upload report
        uses: actions/upload-artifact@v4.6.0
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [format, typecheck, lint, spellcheck, unit-test, e2e-test]
    # only deploy main branch on pushes
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4.2.2
      - name: â” Set up Node.js
        uses: actions/setup-node@v4.2.0
        with:
          cache: npm
          node-version: 22
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      - name: ğŸ©¹ Patch package
        run: npx patch-package
      - name: ğŸ—ƒï¸ Migrate database
        run: npm run db:migrate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      - name: âš™ï¸ Build app
        run: npm run build
        env:
          SENTRY_RELEASE: ${{ github.sha }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      - name: ğŸš† Install Railway
        run: npm i -g @railway/cli
      - name: ğŸš€ Deploy production
        run: railway up --service diswantin-web
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
